<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Eventify</title>
  <meta name="description" content="Manage your events, bookings, and profile on Eventify.">
  
  <!-- Preload fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Styles -->
  <link rel="stylesheet" href="css/styles.css">
  
  <!-- Favicon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ‰</text></svg>">
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar">
    <div class="container">
      <a href="index.html" class="navbar-brand">
        <span class="text-gradient">Eventify</span>
      </a>
      
      <div class="navbar-menu">
        <ul class="navbar-nav">
          <li><a href="index.html">Home</a></li>
          <li><a href="explore.html">Explore</a></li>
          <li><a href="create-event.html" data-auth-required>Create Event</a></li>
          <li><a href="about.html">About</a></li>
        </ul>
        
        <div class="user-info">
          <!-- Will be populated by JavaScript based on auth state -->
        </div>
      </div>
      
      <button class="navbar-toggle" aria-label="Toggle navigation" aria-expanded="false">
        <span>â˜°</span>
      </button>
    </div>
  </nav>

  <!-- Dashboard Header -->
  <section class="section" style="padding-top: var(--space-xl); padding-bottom: var(--space-lg);">
    <div class="container">
      <div class="flex-between" style="flex-wrap: wrap; gap: var(--space-lg);">
        <div>
          <h1 id="dashboardTitle">Dashboard</h1>
          <p class="text-muted" id="dashboardSubtitle">Manage your events and bookings</p>
        </div>
        <div class="flex gap-md">
          <button 
            class="btn btn-outline" 
            onclick="dashboardPage.editProfile()"
            id="editProfileBtn"
          >
            âœï¸ Edit Profile
          </button>
          <a href="create-event.html" class="btn btn-primary" id="createEventBtn" style="display: none;">
            â• Create Event
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Dashboard Content -->
  <main class="section" style="padding-top: 0;">
    <div class="container">
      <!-- User Profile Card -->
      <div class="card" style="margin-bottom: var(--space-2xl);">
        <div class="flex gap-lg" style="align-items: center; flex-wrap: wrap;">
          <div>
            <img 
              id="userAvatar"
              alt="User avatar"
              style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 4px solid var(--accent);"
              onerror="this.src='https://ui-avatars.com/api/?name=User&background=7c5cff&color=ffffff&size=200'"
            >
          </div>
          <div style="flex: 1;">
            <h2 id="userName" style="margin-bottom: var(--space-xs);">User Name</h2>
            <p id="userEmail" class="text-muted" style="margin-bottom: var(--space-sm);">user@example.com</p>
            <div class="flex gap-lg" style="flex-wrap: wrap;">
              <div>
                <span class="text-muted">Phone:</span>
                <span id="userPhone">-</span>
              </div>
              <div>
                <span class="text-muted">Role:</span>
                <span id="userRole" class="event-tag">-</span>
              </div>
            </div>
          </div>
          <div class="flex gap-md" style="flex-wrap: wrap;">
            <div class="text-center">
              <div style="font-size: var(--font-size-2xl); font-weight: 600; color: var(--accent);" id="eventsCreated">0</div>
              <div style="font-size: var(--font-size-sm); color: var(--muted);">Events Created</div>
            </div>
            <div class="text-center">
              <div style="font-size: var(--font-size-2xl); font-weight: 600; color: var(--accent-2);" id="ticketsBooked">0</div>
              <div style="font-size: var(--font-size-sm); color: var(--muted);">Tickets Booked</div>
            </div>
            <div class="text-center">
              <div style="font-size: var(--font-size-2xl); font-weight: 600; color: #28a745;" id="totalRevenue">$0</div>
              <div style="font-size: var(--font-size-sm); color: var(--muted);">Total Revenue</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Dashboard Tabs -->
      <div class="dashboard-tabs" style="margin-bottom: var(--space-xl);">
        <div class="flex" style="border-bottom: 2px solid var(--border); gap: 0;">
          <button 
            class="tab-btn active" 
            data-tab="bookings"
            onclick="dashboardPage.switchTab('bookings')"
          >
            ğŸ« My Bookings
          </button>
          <button 
            class="tab-btn" 
            data-tab="events"
            onclick="dashboardPage.switchTab('events')"
            id="myEventsTab"
          >
            ğŸ“… My Events
          </button>
        </div>
      </div>

      <!-- Tab Content -->
      
      <!-- My Bookings Tab -->
      <div class="tab-content active" data-tab="bookings">
        <div class="flex-between" style="margin-bottom: var(--space-lg); align-items: center;">
          <h3>My Bookings</h3>
          <select id="bookingsFilter" class="form-select" style="width: auto;">
            <option value="all">All Bookings</option>
            <option value="Booked">Booked</option>
            <option value="Pending">Pending</option>
            <option value="Cancelled">Cancelled</option>
          </select>
        </div>
        
        <div id="bookingsContainer">
          <div id="bookingsLoading" class="text-center">
            <p class="text-muted">Loading your bookings...</p>
          </div>
          
          <div id="bookingsList" style="display: none;">
            <!-- Bookings will be populated here -->
          </div>
          
          <div id="noBookings" style="display: none;" class="text-center">
            <div class="card" style="max-width: 400px; margin: 0 auto;">
              <div style="font-size: 3rem; margin-bottom: var(--space-md);">ğŸ«</div>
              <h4>No Bookings Yet</h4>
              <p class="text-muted">You haven't booked any events yet. Start exploring!</p>
              <a href="explore.html" class="btn btn-primary">Browse Events</a>
            </div>
          </div>
        </div>
      </div>

      <!-- My Events Tab (for organizers) -->
      <div class="tab-content" data-tab="events" style="display: none;">
        <div class="flex-between" style="margin-bottom: var(--space-lg); align-items: center;">
          <h3>My Events</h3>
          <div class="flex gap-md">
            <select id="eventsFilter" class="form-select" style="width: auto;">
              <option value="all">All Events</option>
              <option value="upcoming">Upcoming</option>
              <option value="past">Past</option>
            </select>
            <a href="create-event.html" class="btn btn-primary">Create New Event</a>
          </div>
        </div>
        
        <div id="eventsContainer">
          <div id="eventsLoading" class="text-center">
            <p class="text-muted">Loading your events...</p>
          </div>
          
          <div id="eventsList" style="display: none;">
            <!-- Events will be populated here -->
          </div>
          
          <div id="noEvents" style="display: none;" class="text-center">
            <div class="card" style="max-width: 400px; margin: 0 auto;">
              <div style="font-size: 3rem; margin-bottom: var(--space-md);">ğŸ“…</div>
              <h4>No Events Created</h4>
              <p class="text-muted">You haven't created any events yet. Start organizing!</p>
              <a href="create-event.html" class="btn btn-primary">Create Your First Event</a>
            </div>
          </div>
        </div>
      </div>


    </div>
  </main>

  <!-- Edit Profile Modal -->
  <div id="editProfileModal" class="modal-overlay">
    <div class="modal" style="background: var(--bg);">
      <div class="modal-header" style="background: var(--card); padding: var(--space-lg); margin: calc(var(--space-xl) * -1) calc(var(--space-xl) * -1) var(--space-lg); border-radius: var(--radius-lg) var(--radius-lg) 0 0;">
        <h2 class="modal-title" style="color: var(--text);">Edit Profile</h2>
        <button class="modal-close" onclick="dashboardPage.closeEditProfile()">&times;</button>
      </div>
      
      <form id="editProfileForm" novalidate>
        <div class="form-row">
          <div class="form-group">
            <label for="editFirstName" class="form-label">First Name *</label>
            <input 
              type="text" 
              id="editFirstName" 
              name="firstName"
              class="form-input" 
              required
            >
          </div>
          
          <div class="form-group">
            <label for="editLastName" class="form-label">Last Name *</label>
            <input 
              type="text" 
              id="editLastName" 
              name="lastName"
              class="form-input" 
              required
            >
          </div>
        </div>
        
        <div class="form-group">
          <label for="editEmail" class="form-label">Email Address *</label>
          <input 
            type="email" 
            id="editEmail" 
            name="email"
            class="form-input" 
            required
          >
        </div>
        
        <div class="form-group">
          <label for="editPhoneNumber" class="form-label">Phone Number *</label>
          <input 
            type="tel" 
            id="editPhoneNumber" 
            name="phoneNumber"
            class="form-input" 
            placeholder="01012345678"
            pattern="^(010|011|012|015)\d{8}$"
            title="Egyptian mobile number (11 digits starting with 010, 011, 012, or 015)"
            required
          >
          <small class="text-muted">Egyptian mobile number (e.g., 01012345678)</small>
        </div>
        
        <div class="flex gap-md" style="margin-top: var(--space-xl);">
          <button 
            type="button" 
            class="btn btn-outline btn-full" 
            onclick="dashboardPage.closeEditProfile()"
          >
            Cancel
          </button>
          <button 
            type="submit" 
            class="btn btn-primary btn-full"
          >
            Save Changes
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-section">
          <h4>Eventify</h4>
          <p>Connecting people through amazing events and experiences.</p>
          <div class="social-links">
            <a href="#" aria-label="Twitter">ğŸ¦</a>
            <a href="#" aria-label="Facebook">ğŸ“˜</a>
            <a href="#" aria-label="Instagram">ğŸ“·</a>
            <a href="#" aria-label="LinkedIn">ğŸ’¼</a>
          </div>
        </div>
        
        <div class="footer-section">
          <h4>For Attendees</h4>
          <ul>
            <li><a href="explore.html">Find Events</a></li>
            <li><a href="login.html">My Tickets</a></li>
            <li><a href="about.html">Help Center</a></li>
          </ul>
        </div>
        
        <div class="footer-section">
          <h4>For Organizers</h4>
          <ul>
            <li><a href="create-event.html">Create Event</a></li>
            <li><a href="dashboard.html">Manage Events</a></li>
            <li><a href="about.html">Resources</a></li>
          </ul>
        </div>
        
        <div class="footer-section">
          <h4>Company</h4>
          <ul>
            <li><a href="about.html">About Us</a></li>
            <li><a href="about.html">Contact</a></li>
            <li><a href="#" onclick="app.showNotification('Privacy policy coming soon!', 'info')">Privacy</a></li>
            <li><a href="#" onclick="app.showNotification('Terms of service coming soon!', 'info')">Terms</a></li>
          </ul>
        </div>
      </div>
      
      <div class="footer-bottom">
        <p>&copy; 2025 Eventify. All rights reserved.</p>
        <p class="text-muted">Built with â¤ï¸ for event lovers</p>
      </div>
    </div>
  </footer>

  <!-- Scripts -->
  <script src="js/events-data.js"></script>
  <script src="js/app.js"></script>
  <script>
    // Dashboard-specific JavaScript will be included inline for this demo
    class DashboardPage {
      constructor() {
        this.user = null;
        this.currentTab = 'bookings';
        this.bookings = [];
        this.userEvents = [];
        
        this.init();
      }

      async init() {
        // Check authentication - first get fresh data from API
        try {
          this.user = await app.fetchCurrentUser();
        } catch (error) {
          console.error('Error fetching user data:', error);
        }
        
        if (!this.user) {
          app.showNotification('Please log in to access your dashboard', 'warning');
          setTimeout(() => {
            window.location.href = 'login.html?redirect=dashboard.html';
          }, 1000);
          return;
        }

        // Wait a tick to ensure DOM is ready
        await new Promise(resolve => setTimeout(resolve, 100));
        
        this.loadUserProfile();
        await this.loadUserData();
        this.setupEventHandlers();
        this.setupFilters();
      }

      loadUserProfile() {
        if (!this.user) {
          console.error('No user data available');
          return;
        }

        console.log('Loading user profile with data:', this.user);

        try {
          // Update profile display
          const userNameElement = document.getElementById('userName');
          const userEmailElement = document.getElementById('userEmail');
          const userAvatarElement = document.getElementById('userAvatar');
          const userPhoneElement = document.getElementById('userPhone');
          const roleElement = document.getElementById('userRole');

          console.log('Found elements:', {
            userName: !!userNameElement,
            userEmail: !!userEmailElement,
            userAvatar: !!userAvatarElement,
            userPhone: !!userPhoneElement,
            userRole: !!roleElement
          });

          if (userNameElement) {
            userNameElement.textContent = this.user.name || 'User Name';
            userNameElement.innerHTML = this.user.name || 'User Name';
            console.log('Set userName to:', this.user.name);
            console.log('userName element now contains:', userNameElement.textContent);
          }
          
          if (userEmailElement) {
            userEmailElement.textContent = this.user.email || 'user@example.com';
            userEmailElement.innerHTML = this.user.email || 'user@example.com';
            console.log('Set userEmail to:', this.user.email);
            console.log('userEmail element now contains:', userEmailElement.textContent);
          }
          
          if (userAvatarElement) {
            userAvatarElement.src = this.user.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(this.user.name || 'User')}&background=7c5cff&color=ffffff&size=200`;
          }
          
          // Set phone number from API
          if (userPhoneElement) {
            userPhoneElement.textContent = this.user.phone || this.user.phoneNumber || '-';
            console.log('Set userPhone to:', this.user.phone || this.user.phoneNumber);
          }

          // Set role - display the actual role from API
          if (roleElement) {
            roleElement.textContent = this.user.role || 'User';
            console.log('Set userRole to:', roleElement.textContent);
          }
          
          // Show organizer-specific elements
          if (this.user.role === 'organizer' || this.user.userType === 'both' || this.user.userType === 'organizer') {
            const myEventsTab = document.getElementById('myEventsTab');
            const createEventBtn = document.getElementById('createEventBtn');
            if (myEventsTab) myEventsTab.style.display = 'block';
            if (createEventBtn) createEventBtn.style.display = 'inline-flex';
          }
        } catch (error) {
          console.error('Error loading user profile:', error);
        }
      }

      async loadUserData() {
        try {
          // Load bookings
          await this.loadBookings();
          
          // Load user events to calculate revenue
          await this.loadUserEvents();
          
          // Update statistics (needs events count, so fetch count from API)
          await this.updateStatistics();
          
        } catch (error) {
          console.error('Error loading user data:', error);
          app.showNotification('Error loading dashboard data', 'error');
        }
      }

      async loadBookings() {
        const token = localStorage.getItem('eventify_token');
        if (!token) {
          this.bookings = [];
          this.displayBookings();
          return;
        }

        // Show loading state
        document.getElementById('bookingsLoading').style.display = 'block';
        document.getElementById('bookingsList').style.display = 'none';

        try {
          const baseUrl = window.API_BASE_URL || 'https://eventify.runasp.net';
          const response = await fetch(`${baseUrl}/api/Booking/User`, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });

          if (response.ok) {
            const result = await response.json();
            console.log('Bookings API response:', result);
            
            if (result.success && result.data && Array.isArray(result.data)) {
              // Map API response to our booking format, include all bookings even if event is deleted
              this.bookings = result.data
                .filter(booking => booking != null)
                .map(booking => {
                  // Convert enum number to text
                  let statusText = 'Unknown';
                  if (booking.status === 0 || booking.status === 'Booked') {
                    statusText = 'Booked';
                  } else if (booking.status === 1 || booking.status === 'Pending') {
                    statusText = 'Pending';
                  } else if (booking.status === 2 || booking.status === 'Cancelled') {
                    statusText = 'Cancelled';
                  }
                  
                  // Handle cases where event might be null (deleted/refunded)
                  const hasEvent = booking.event && booking.event.id && booking.event.name;
                  
                  let eventDate = null;
                  let eventTime = null;
                  
                  if (hasEvent && booking.event.startDate) {
                    try {
                      eventDate = booking.event.startDate.split('T')[0];
                      eventTime = new Date(booking.event.startDate).toTimeString().substring(0, 5);
                    } catch (e) {
                      console.warn('Error parsing event date:', e);
                    }
                  }
                  
                  return {
                    id: booking.id,
                    eventId: hasEvent ? booking.event.id : null,
                    eventTitle: hasEvent ? booking.event.name : 'Event Deleted',
                    eventDate: eventDate,
                    eventTime: eventTime,
                    eventLocation: hasEvent ? (booking.event.address || 'N/A') : 'N/A',
                    eventImage: hasEvent ? (booking.event.photoUrl || 'https://images.unsplash.com/photo-1540575467063-178a50c2df87?w=400') : 'https://images.unsplash.com/photo-1540575467063-178a50c2df87?w=400',
                    tickets: booking.ticketsNum || 0,
                    total: booking.payment ? booking.payment.totalPrice : 0,
                    status: statusText,
                    bookingDate: booking.createdDate,
                    paymentStatus: booking.payment ? booking.payment.status : 'Unknown',
                    paymentMethod: booking.payment ? booking.payment.paymentMethod : '',
                    attendeeInfo: {
                      name: this.user?.name || 'N/A',
                      email: this.user?.email || 'N/A'
                    },
                    // Store full booking data for details page
                    fullData: booking,
                    isEventDeleted: !hasEvent
                  };
                });
              
              console.log('Loaded bookings from API:', this.bookings);
            } else {
              console.error('API response not successful:', result.message);
              this.bookings = [];
            }
          } else {
            console.error('Failed to fetch bookings:', response.status);
            this.bookings = [];
          }
        } catch (error) {
          console.error('Error fetching bookings:', error);
          this.bookings = [];
        }
        
        this.displayBookings();
        
        // Store bookings in localStorage for booking-details page
        localStorage.setItem('eventify_user_bookings', JSON.stringify(this.bookings));
        
        setTimeout(() => {
          document.getElementById('bookingsLoading').style.display = 'none';
          document.getElementById('bookingsList').style.display = 'block';
        }, 500);
      }

      async loadUserEvents() {
        const token = localStorage.getItem('eventify_token');
        if (!token) {
          this.userEvents = [];
          this.displayUserEvents();
          return;
        }

        // Get organizer ID from user data
        const organizerId = this.user.id;
        if (!organizerId) {
          console.error('No organizer ID found');
          this.userEvents = [];
          this.displayUserEvents();
          return;
        }

        // Show loading state
        document.getElementById('eventsLoading').style.display = 'block';
        document.getElementById('eventsList').style.display = 'none';

        try {
          const baseUrl = window.API_BASE_URL || 'https://eventify.runasp.net';
          const response = await fetch(`${baseUrl}/api/Events/organizer/${organizerId}`, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });

          if (response.ok) {
            const result = await response.json();
            console.log('API Response:', result);
            console.log('API Response Data (first event):', result.data && result.data[0] ? result.data[0] : 'No events');
            
            if (result.success && result.data) {
              // Map API response to our event format
              this.userEvents = result.data.map(event => {
                console.log('Mapping event:', JSON.stringify(event, null, 2));
                return {
                  id: event.id,
                  title: event.name,  // API uses 'name' not 'title'
                  description: event.description,
                  location: event.address,  // API uses 'address' not 'location'
                  eventDate: event.startDate,
                  startDate: event.startDate,
                  endDate: event.endDate,
                  photoUrl: event.photoUrl,
                  image: event.photoUrl,
                  capacity: event.capacity || 0,
                  availableSeats: event.availableTickets || 0,
                  bookedTickets: event.bookedTickets || 0,
                  price: event.price || 0,
                  revenue: event.revenue || 0,
                  isUpcoming: event.isUpcoming,
                  status: event.status
                };
              });
              
              console.log('Loaded user events from API:', this.userEvents);
            } else {
              console.error('API response not successful:', result.message);
              this.userEvents = [];
            }
          } else {
            console.error('Failed to fetch user events:', response.status);
            this.userEvents = [];
          }
        } catch (error) {
          console.error('Error fetching user events:', error);
          this.userEvents = [];
        }
        
        this.displayUserEvents();
        
        // Update total revenue after events are loaded
        this.fetchTotalRevenue();
        
        setTimeout(() => {
          document.getElementById('eventsLoading').style.display = 'none';
          document.getElementById('eventsList').style.display = 'block';
        }, 500);
      }

      async updateStatistics() {
        // Fetch events count from API
        await this.fetchEventsCount();
        
        // Fetch booked tickets count from API
        await this.fetchBookedTicketsCount();
        
        // Total revenue will be calculated when events are loaded
      }

      async fetchEventsCount() {
        const token = localStorage.getItem('eventify_token');
        if (!token) {
          document.getElementById('eventsCreated').textContent = '0';
          return;
        }

        const organizerId = this.user.id;
        if (!organizerId) {
          document.getElementById('eventsCreated').textContent = '0';
          return;
        }

        try {
          const baseUrl = window.API_BASE_URL || 'https://eventify.runasp.net';
          const response = await fetch(`${baseUrl}/api/Events/organizer/${organizerId}`, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });

          if (response.ok) {
            const result = await response.json();
            if (result.success && result.data) {
              document.getElementById('eventsCreated').textContent = result.data.length || 0;
            } else {
              document.getElementById('eventsCreated').textContent = this.userEvents.length;
            }
          } else {
            document.getElementById('eventsCreated').textContent = this.userEvents.length;
          }
        } catch (error) {
          console.error('Error fetching events count:', error);
          document.getElementById('eventsCreated').textContent = this.userEvents.length;
        }
      }

      async fetchBookedTicketsCount() {
        const token = localStorage.getItem('eventify_token');
        if (!token) {
          document.getElementById('ticketsBooked').textContent = '0';
          return;
        }

        try {
          const baseUrl = window.API_BASE_URL || 'https://eventify.runasp.net';
          const response = await fetch(`${baseUrl}/api/User/booked`, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });

          if (response.ok) {
            const result = await response.json();
            console.log('Booked tickets API response:', result);
            
            if (result.success && result.data !== undefined) {
              document.getElementById('ticketsBooked').textContent = result.data;
            } else {
              console.error('Invalid API response for booked tickets:', result);
              document.getElementById('ticketsBooked').textContent = '0';
            }
          } else {
            console.error('Failed to fetch booked tickets:', response.status);
            document.getElementById('ticketsBooked').textContent = '0';
          }
        } catch (error) {
          console.error('Error fetching booked tickets count:', error);
          document.getElementById('ticketsBooked').textContent = '0';
        }
      }

      async fetchTotalRevenue() {
        // Calculate total revenue from loaded user events
        const revenueElement = document.getElementById('totalRevenue');
        if (!revenueElement) return;
        
        // Sum revenue from all user events (only include paid bookings)
        const totalRevenue = this.userEvents.reduce((sum, event) => {
          return sum + (event.revenue || 0);
        }, 0);
        
        // Format revenue as currency
        revenueElement.textContent = `EGP ${totalRevenue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      }

      displayBookings() {
        const container = document.getElementById('bookingsList');
        const noBookings = document.getElementById('noBookings');
        
        if (this.bookings.length === 0) {
          container.style.display = 'none';
          noBookings.style.display = 'block';
          return;
        }

        container.innerHTML = this.bookings.map(booking => this.createBookingCard(booking)).join('');
        container.style.display = 'block';
        noBookings.style.display = 'none';
      }

      createBookingCard(booking) {
        const isPastEvent = booking.eventDate ? new Date(booking.eventDate + 'T' + booking.eventTime) < new Date() : false;
        const formattedDate = booking.eventDate ? EventifyData.formatDate(booking.eventDate) : 'N/A';
        const formattedTime = booking.eventTime ? EventifyData.formatTime(booking.eventTime) : 'N/A';
        
        // Get event photo URL with cache-busting
        const timestamp = new Date().getTime();
        const imageUrl = (booking.eventPhoto || booking.photoUrl || booking.eventImage || 'https://images.unsplash.com/photo-1540575467063-178a50c2df87?w=160&h=160&fit=crop') + (booking.eventPhoto || booking.photoUrl || booking.eventImage ? `?t=${timestamp}` : '');

        return `
          <div class="card" style="margin-bottom: var(--space-md);" data-booking-status="${booking.status}" data-is-past="${isPastEvent}">
            <div class="flex gap-lg" style="align-items: center; flex-wrap: wrap;">
              <img 
                src="${imageUrl}" 
                alt="${booking.eventTitle}"
                style="width: 80px; height: 80px; object-fit: cover; border-radius: var(--radius-md);"
                onerror="this.src='https://images.unsplash.com/photo-1540575467063-178a50c2df87?w=160&h=160&fit=crop'"
              >
              
              <div style="flex: 1; min-width: 200px;">
                <h4 style="margin-bottom: var(--space-xs);">${booking.eventTitle}</h4>
                <p style="margin-bottom: var(--space-sm); color: var(--muted);">
                  ğŸ“… ${formattedDate}${booking.eventTime ? ' at ' + formattedTime : ''}<br>
                  ğŸ“ ${booking.eventLocation}
                </p>
                <div class="flex gap-sm" style="align-items: center; flex-wrap: wrap;">
                  <span class="event-tag">${booking.tickets} ticket${booking.tickets > 1 ? 's' : ''}</span>
                  <span class="event-tag" style="background: ${
                    booking.status === 'Booked' ? '#10b981' : 
                    booking.status === 'Pending' ? '#f59e0b' : 
                    booking.status === 'Cancelled' ? '#ef4444' : 'var(--muted)'
                  }; color: white;">
                    ${booking.status}
                  </span>
                </div>
              </div>
              
              <div style="text-align: right;">
                <div style="font-weight: 600; margin-bottom: var(--space-sm); color: var(--accent);">
                  ${booking.total === 0 ? 'Free' : app.formatCurrency(booking.total)}
                </div>
                <div style="font-size: var(--font-size-sm); color: var(--muted); margin-bottom: var(--space-md);">
                  Booking #${booking.id}
                </div>
                <div class="flex gap-sm">
                  <button 
                    class="btn btn-sm btn-outline" 
                    onclick="dashboardPage.viewBookingDetails('${booking.id}')"
                  >
                    View Details
                  </button>
                  <a 
                    href="event.html?id=${booking.eventId}" 
                    class="btn btn-sm btn-primary"
                  >
                    View Event
                  </a>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      displayUserEvents() {
        const container = document.getElementById('eventsList');
        const noEvents = document.getElementById('noEvents');
        
        console.log('displayUserEvents called with:', this.userEvents);
        console.log('Container element:', container);
        console.log('No events element:', noEvents);
        
        if (this.userEvents.length === 0) {
          console.log('No events to display');
          container.style.display = 'none';
          noEvents.style.display = 'block';
          return;
        }

        console.log('Generating event cards...');
        const cardsHTML = this.userEvents.map(event => {
          const card = this.createEventCard(event);
          console.log('Generated card for event:', event.title, card.substring(0, 100));
          return card;
        }).join('');
        
        container.innerHTML = cardsHTML;
        container.style.display = 'block';
        noEvents.style.display = 'none';
        console.log('Events displayed successfully');
      }

      createEventCard(event) {
        console.log('createEventCard called with:', event);
        console.log('All event properties:', Object.keys(event));
        console.log('Raw date fields - eventDate:', event.eventDate, 'startDate:', event.startDate, 'date:', event.date, 'time:', event.time);
        
        // Parse date - handle both formats
        // Skip 0001-01-01 (default .NET DateTime value)
        let eventDate;
        const isValidDate = (dateStr) => {
          return dateStr && !dateStr.startsWith('0001-01-01');
        };
        
        if (isValidDate(event.startDate)) {
          eventDate = new Date(event.startDate);
        } else if (isValidDate(event.eventDate)) {
          eventDate = new Date(event.eventDate);
        } else if (event.date && event.time) {
          eventDate = new Date(event.date + 'T' + event.time);
        } else if (event.date) {
          eventDate = new Date(event.date);
        } else {
          // If no valid date found, treat as future event to allow editing
          console.warn('No valid date found for event:', event.title || event.eventName);
          eventDate = new Date('2099-12-31'); // Far future date as fallback
        }
        
        const now = new Date();
        console.log('Event:', event.title || event.eventName);
        console.log('Event date:', eventDate.toISOString(), 'Local:', eventDate.toLocaleString());
        console.log('Current time:', now.toISOString(), 'Local:', now.toLocaleString());
        console.log('Is past?', eventDate < now);
        
        const isPastEvent = eventDate < now;
        const formattedDate = eventDate.toLocaleDateString('en-US', { 
          month: 'short', 
          day: 'numeric', 
          year: 'numeric' 
        });
        const formattedTime = eventDate.toLocaleTimeString('en-US', { 
          hour: 'numeric', 
          minute: '2-digit' 
        });

        // Use photoUrl from API or fallback to image property
        // Add timestamp to cache-bust image
        const timestamp = new Date().getTime();
        const imageUrl = (event.photoUrl || event.image || 'https://images.unsplash.com/photo-1540575467063-178a50c2df87?w=160&h=160&fit=crop') + (event.photoUrl || event.image ? `?t=${timestamp}` : '');

        return `
          <div class="card" style="margin-bottom: var(--space-md);">
            <div class="flex gap-lg" style="align-items: center; flex-wrap: wrap;">
              <img 
                src="${imageUrl}" 
                alt="${event.title || event.eventName || 'Event'}"
                style="width: 80px; height: 80px; object-fit: cover; border-radius: var(--radius-md);"
                onerror="this.src='https://images.unsplash.com/photo-1540575467063-178a50c2df87?w=160&h=160&fit=crop'"
              >
              
              <div style="flex: 1; min-width: 200px;">
                <h4 style="margin-bottom: var(--space-xs);">${event.title || event.eventName || 'Untitled Event'}</h4>
                <p style="margin-bottom: var(--space-sm); color: var(--muted);">
                  ğŸ“… ${formattedDate} at ${formattedTime}<br>
                  ğŸ“ ${event.location || event.venue || 'TBA'}
                </p>
                <div class="flex gap-sm" style="align-items: center; flex-wrap: wrap;">
                  ${event.capacity && event.capacity > 0 ? `<span class="event-tag">${event.capacity} capacity</span>` : ''}
                  ${event.bookedTickets !== undefined && event.bookedTickets >= 0 ? `<span class="event-tag">${event.bookedTickets} booked</span>` : ''}
                  <span class="event-tag" style="background: ${isPastEvent ? 'var(--muted)' : 'var(--success)'}; color: white;">
                    ${isPastEvent ? 'Past Event' : 'Upcoming'}
                  </span>
                </div>
              </div>
              
              <div style="text-align: right;">
                ${event.revenue !== undefined && event.revenue >= 0 ? `
                <div style="font-size: var(--font-size-lg); font-weight: 600; color: #28a745; margin-bottom: var(--space-2xl);">
                  ğŸ’° ${app.formatCurrency(event.revenue)}
                </div>
                ` : ''}
                <div class="flex gap-sm">
                  ${!isPastEvent ? `
                  <button 
                    class="btn btn-sm btn-outline" 
                    onclick="dashboardPage.editEvent(${event.id || event.eventId})"
                  >
                    âœï¸ Edit
                  </button>
                  ` : ''}
                  <a 
                    href="event.html?id=${event.id || event.eventId}" 
                    class="btn btn-sm btn-primary"
                  >
                    View Event
                  </a>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      // Tab switching
      switchTab(tabName) {
        this.currentTab = tabName;
        
        // Update tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.tab === tabName);
        });
        
        // Update tab content
        document.querySelectorAll('.tab-content').forEach(content => {
          content.style.display = content.dataset.tab === tabName ? 'block' : 'none';
        });
        
        // Load data when switching to events tab
        if (tabName === 'events' && this.userEvents.length === 0) {
          this.loadUserEvents();
        }
      }

      // Setup event handlers
      setupEventHandlers() {
        // Edit profile form
        const editForm = document.getElementById('editProfileForm');
        if (editForm) {
          editForm.addEventListener('submit', (e) => this.handleProfileUpdate(e));
        }
      }

      // Setup filters
      setupFilters() {
        const bookingsFilter = document.getElementById('bookingsFilter');
        const eventsFilter = document.getElementById('eventsFilter');

        if (bookingsFilter) {
          bookingsFilter.addEventListener('change', () => {
            this.filterBookings(bookingsFilter.value);
          });
        }

        if (eventsFilter) {
          eventsFilter.addEventListener('change', () => {
            this.filterEvents(eventsFilter.value);
          });
        }
      }

      // Filter bookings
      filterBookings(filter) {
        const allCards = document.querySelectorAll('#bookingsList .card');
        
        allCards.forEach(card => {
          const bookingStatus = card.dataset.bookingStatus;
          
          let show = true;
          
          if (filter === 'all') {
            show = true;
          } else {
            // Match exact status from BookingStatus enum
            show = bookingStatus === filter;
          }
          
          card.style.display = show ? 'block' : 'none';
        });
      }

      // Filter events
      filterEvents(filter) {
        const allCards = document.querySelectorAll('#eventsList .card');
        
        allCards.forEach(card => {
          const eventDate = card.querySelector('.event-tag:last-child').textContent;
          const isPast = eventDate.includes('Past');
          
          let show = true;
          
          switch (filter) {
            case 'upcoming':
              show = !isPast;
              break;
            case 'past':
              show = isPast;
              break;
            default:
              show = true;
          }
          
          card.style.display = show ? 'block' : 'none';
        });
      }

      // Profile editing
      editProfile() {
        const modal = document.getElementById('editProfileModal');
        
        // Prefill form
        const nameParts = this.user.name.split(' ');
        document.getElementById('editFirstName').value = nameParts[0] || '';
        document.getElementById('editLastName').value = nameParts.slice(1).join(' ') || '';
        document.getElementById('editEmail').value = this.user.email;
        document.getElementById('editPhoneNumber').value = this.user.phone || this.user.phoneNumber || '';
        
        app.openModal('editProfileModal');
      }

      closeEditProfile() {
        app.closeModal(document.getElementById('editProfileModal'));
      }

      async handleProfileUpdate(event) {
        event.preventDefault();
        
        const form = event.target;
        
        if (!form.checkValidity()) {
          app.showNotification('Please fill in all required fields correctly', 'error');
          form.reportValidity();
          return;
        }

        const formData = new FormData(form);
        const fullName = `${formData.get('firstName').trim()} ${formData.get('lastName').trim()}`;
        const email = formData.get('email').trim();
        const phoneNumber = formData.get('phoneNumber').trim();

        // Validate phone number format
        const phonePattern = /^(010|011|012|015)\d{8}$/;
        if (!phonePattern.test(phoneNumber)) {
          app.showNotification('Invalid phone number format. Use Egyptian mobile number (e.g., 01012345678)', 'error');
          return;
        }

        try {
          const token = localStorage.getItem('eventify_token');
          if (!token) {
            app.showNotification('Please log in again', 'error');
            window.location.href = 'login.html';
            return;
          }

          const userId = this.user.id;
          if (!userId) {
            app.showNotification('User ID not found', 'error');
            return;
          }

          const baseUrl = window.API_BASE_URL || 'https://eventify.runasp.net';
          const response = await fetch(`${baseUrl}/api/User/${userId}`, {
            method: 'PUT',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              name: fullName,
              email: email,
              phoneNumber: phoneNumber
            })
          });

          if (response.ok) {
            const result = await response.json();
            console.log('Profile update response:', result);
            
            if (result.success) {
              // Update local user data
              const updatedUser = {
                ...this.user,
                name: result.data.name,
                email: result.data.email,
                phone: result.data.phoneNumber,
                phoneNumber: result.data.phoneNumber
              };

              app.setCurrentUser(updatedUser);
              this.user = updatedUser;
              
              // Refresh profile display
              this.loadUserProfile();
              
              // Close modal
              this.closeEditProfile();
              
              app.showNotification('Profile updated successfully!', 'success');
            } else {
              const errorMsg = result.errors && result.errors.length > 0 
                ? result.errors.join(', ') 
                : result.message || 'Failed to update profile';
              app.showNotification(errorMsg, 'error');
            }
          } else {
            const errorData = await response.json().catch(() => ({}));
            const errorMsg = errorData.errors && errorData.errors.length > 0
              ? errorData.errors.join(', ')
              : errorData.message || 'Failed to update profile';
            app.showNotification(errorMsg, 'error');
          }
        } catch (error) {
          console.error('Error updating profile:', error);
          app.showNotification('Error updating profile. Please try again.', 'error');
        }
      }

      // Booking details
      viewBookingDetails(bookingId) {
        // Redirect to booking details page
        window.location.href = `booking-details.html?id=${bookingId}`;
      }

      // Event editing
      editEvent(eventId) {
        // Redirect to edit event page
        window.location.href = `edit-event.html?id=${eventId}`;
      }
    }

    // Tab button styles
    const style = document.createElement('style');
    style.textContent = `
      .tab-btn {
        padding: var(--space-md) var(--space-lg);
        background: none;
        border: none;
        border-bottom: 2px solid transparent;
        color: var(--muted);
        cursor: pointer;
        font-weight: 500;
        transition: all var(--anim-speed) ease;
      }
      
      .tab-btn:hover,
      .tab-btn.active {
        color: var(--text);
        border-bottom-color: var(--accent);
      }
    `;
    document.head.appendChild(style);

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', () => {
      if (window.EventifyData) {
        window.dashboardPage = new DashboardPage();
        
        // Check if returning from a cancelled booking and refresh if needed
        if (sessionStorage.getItem('eventify_booking_cancelled') === 'true') {
          sessionStorage.removeItem('eventify_booking_cancelled');
          
          // Show notification and force reload bookings
          setTimeout(() => {
            app.showNotification('Bookings updated - refund processed', 'success');
            if (window.dashboardPage) {
              window.dashboardPage.loadBookings();
            }
          }, 500);
        }
      } else {
        console.error('EventifyData not loaded');
      }
    });
  </script>
</body>
</html>