<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Booking Debug Test</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
    .debug-panel { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .debug-panel h3 { margin-top: 0; color: #333; }
    .status { padding: 10px; margin: 5px 0; border-radius: 4px; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .info { background: #d1ecf1; color: #0c5460; }
    button { padding: 10px 20px; margin: 5px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; }
    button:hover { background: #0056b3; }
    pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>üîç Booking Page Debug Tool</h1>
  
  <div class="debug-panel">
    <h3>1. Check LocalStorage Auth</h3>
    <div id="authStatus"></div>
    <button onclick="checkAuth()">Refresh Auth Check</button>
  </div>

  <div class="debug-panel">
    <h3>2. Test API Connection</h3>
    <div id="apiStatus"></div>
    <button onclick="testAPI()">Test API</button>
  </div>

  <div class="debug-panel">
    <h3>3. Test Event API</h3>
    <label>Event ID: <input type="number" id="eventId" value="1" style="width: 100px;"></label>
    <button onclick="testEventAPI()">Test Event API</button>
    <div id="eventStatus"></div>
  </div>

  <div class="debug-panel">
    <h3>4. Test Category API</h3>
    <label>Category ID: <input type="number" id="categoryId" value="1" style="width: 100px;"></label>
    <button onclick="testCategoryAPI()">Test Category API</button>
    <div id="categoryStatus"></div>
  </div>

  <div class="debug-panel">
    <h3>5. Create Test Token</h3>
    <p>If you don't have a token, enter test data:</p>
    <label>Token: <input type="text" id="testToken" placeholder="Bearer token..." style="width: 300px;"></label><br>
    <label>User ID: <input type="number" id="testUserId" value="1" style="width: 100px;"></label><br>
    <button onclick="setTestAuth()">Set Test Auth</button>
    <button onclick="clearAuth()">Clear Auth</button>
  </div>

  <div class="debug-panel">
    <h3>6. Test Booking Page Link</h3>
    <label>Event ID: <input type="number" id="bookEventId" value="1" style="width: 100px;"></label>
    <label>Category ID: <input type="number" id="bookCategoryId" value="1" style="width: 100px;"></label>
    <button onclick="goToBooking()">Go to Booking Page</button>
  </div>

  <script>
    const API_BASE_URL = 'https://eventify.runasp.net/api';

    function getAuthToken() {
      return localStorage.getItem('token') 
          || localStorage.getItem('eventify_token') 
          || localStorage.getItem('authToken')
          || null;
    }

    function getUserId() {
      let userId = localStorage.getItem('userId') || localStorage.getItem('user_id');
      
      if (!userId) {
        const userJson = localStorage.getItem('eventifyUser');
        if (userJson) {
          try {
            const user = JSON.parse(userJson);
            userId = user.id || user.userId;
          } catch (e) {
            console.error('Error parsing eventifyUser:', e);
          }
        }
      }
      
      return userId;
    }

    function checkAuth() {
      const token = getAuthToken();
      const userId = getUserId();
      const statusDiv = document.getElementById('authStatus');
      
      let html = '';
      
      // Check all possible token locations
      const allTokens = {
        'token': localStorage.getItem('token'),
        'eventify_token': localStorage.getItem('eventify_token'),
        'authToken': localStorage.getItem('authToken')
      };
      
      html += '<h4>Token Storage:</h4><pre>' + JSON.stringify(allTokens, null, 2) + '</pre>';
      
      if (token) {
        html += `<div class="status success">‚úÖ Token Found: ${token.substring(0, 20)}...</div>`;
      } else {
        html += '<div class="status error">‚ùå No Token Found</div>';
      }
      
      if (userId) {
        html += `<div class="status success">‚úÖ User ID Found: ${userId}</div>`;
      } else {
        html += '<div class="status error">‚ùå No User ID Found</div>';
      }
      
      statusDiv.innerHTML = html;
    }

    async function testAPI() {
      const statusDiv = document.getElementById('apiStatus');
      statusDiv.innerHTML = '<div class="status info">Testing API connection...</div>';
      
      try {
        const response = await fetch(`${API_BASE_URL}/Events`);
        const data = await response.json();
        
        if (response.ok) {
          statusDiv.innerHTML = `<div class="status success">‚úÖ API Connected (Status: ${response.status})</div>
                                 <pre>${JSON.stringify(data, null, 2).substring(0, 500)}...</pre>`;
        } else {
          statusDiv.innerHTML = `<div class="status error">‚ùå API Error (Status: ${response.status})</div>
                                 <pre>${JSON.stringify(data, null, 2)}</pre>`;
        }
      } catch (error) {
        statusDiv.innerHTML = `<div class="status error">‚ùå Connection Failed: ${error.message}</div>`;
      }
    }

    async function testEventAPI() {
      const eventId = document.getElementById('eventId').value;
      const statusDiv = document.getElementById('eventStatus');
      const token = getAuthToken();
      
      statusDiv.innerHTML = '<div class="status info">Testing Event API...</div>';
      
      try {
        const response = await fetch(`${API_BASE_URL}/Events/${eventId}`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        const data = await response.json();
        
        if (response.ok && data.success) {
          statusDiv.innerHTML = `<div class="status success">‚úÖ Event Found (ID: ${eventId})</div>
                                 <pre>${JSON.stringify(data, null, 2).substring(0, 800)}...</pre>`;
        } else {
          statusDiv.innerHTML = `<div class="status error">‚ùå Event API Error (Status: ${response.status})</div>
                                 <pre>${JSON.stringify(data, null, 2)}</pre>`;
        }
      } catch (error) {
        statusDiv.innerHTML = `<div class="status error">‚ùå Event API Failed: ${error.message}</div>`;
      }
    }

    async function testCategoryAPI() {
      const categoryId = document.getElementById('categoryId').value;
      const statusDiv = document.getElementById('categoryStatus');
      const token = getAuthToken();
      
      statusDiv.innerHTML = '<div class="status info">Testing Category API...</div>';
      
      try {
        const response = await fetch(`${API_BASE_URL}/Categories/${categoryId}`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        const data = await response.json();
        
        if (response.ok && data.success) {
          statusDiv.innerHTML = `<div class="status success">‚úÖ Category Found (ID: ${categoryId})</div>
                                 <pre>${JSON.stringify(data, null, 2)}</pre>`;
        } else {
          statusDiv.innerHTML = `<div class="status error">‚ùå Category API Error (Status: ${response.status})</div>
                                 <pre>${JSON.stringify(data, null, 2)}</pre>`;
        }
      } catch (error) {
        statusDiv.innerHTML = `<div class="status error">‚ùå Category API Failed: ${error.message}</div>`;
      }
    }

    function setTestAuth() {
      const token = document.getElementById('testToken').value;
      const userId = document.getElementById('testUserId').value;
      
      if (token) {
        localStorage.setItem('token', token);
        alert('Test token set!');
      }
      
      if (userId) {
        localStorage.setItem('userId', userId);
        alert('Test user ID set!');
      }
      
      checkAuth();
    }

    function clearAuth() {
      localStorage.removeItem('token');
      localStorage.removeItem('eventify_token');
      localStorage.removeItem('authToken');
      localStorage.removeItem('userId');
      localStorage.removeItem('user_id');
      localStorage.removeItem('eventifyUser');
      alert('Auth data cleared!');
      checkAuth();
    }

    function goToBooking() {
      const eventId = document.getElementById('bookEventId').value;
      const categoryId = document.getElementById('bookCategoryId').value;
      
      const url = `book.html?eventId=${eventId}&categoryId=${categoryId}`;
      console.log('Navigating to:', url);
      window.location.href = url;
    }

    // Auto-run auth check on load
    window.addEventListener('DOMContentLoaded', () => {
      checkAuth();
    });
  </script>
</body>
</html>
