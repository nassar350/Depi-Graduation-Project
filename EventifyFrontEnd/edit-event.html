<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Event - Eventify</title>
  <link rel="stylesheet" href="css/styles.css">
  
  <!-- Favicon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚úèÔ∏è</text></svg>">
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar">
    <div class="container">
      <div class="navbar-brand">
        <a href="index.html">
          <span style="font-size: var(--font-size-xl); font-weight: 700;">üéâ Eventify</span>
        </a>
      </div>
      <ul class="navbar-nav">
        <li><a href="index.html">Home</a></li>
        <li><a href="explore.html">Explore</a></li>
        <li><a href="dashboard.html">Dashboard</a></li>
      </ul>
      <div class="navbar-actions">
        <a href="#" onclick="app.logout(); return false;" class="btn btn-outline">Logout</a>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="main-content">
    <div class="container" style="max-width: 900px; padding-top: var(--space-xl); padding-bottom: var(--space-xl);">
      
      <!-- Back Button -->
      <div style="margin-bottom: var(--space-lg);">
        <a href="dashboard.html" class="btn btn-outline">
          ‚Üê Back to Dashboard
        </a>
      </div>

      <!-- Edit Event Form -->
      <div class="card">
        <div style="border-bottom: 2px solid var(--border); padding-bottom: var(--space-lg); margin-bottom: var(--space-lg);">
          <h1 style="margin-bottom: var(--space-xs);">Edit Event</h1>
          <p class="text-muted">Update your event details</p>
        </div>

        <form id="editEventForm" novalidate>
          <!-- Event Details -->
          <div style="margin-bottom: var(--space-xl);">
            <h3 style="margin-bottom: var(--space-md);">Event Details</h3>
            
            <div class="form-group">
              <label for="eventTitle" class="form-label">Event Name *</label>
              <input 
                type="text" 
                id="eventTitle" 
                name="title"
                class="form-input" 
                required
                placeholder="Event name"
              >
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="startDate" class="form-label">Start Date & Time *</label>
                <input 
                  type="datetime-local" 
                  id="startDate" 
                  name="startDate"
                  class="form-input" 
                  required
                >
              </div>

              <div class="form-group">
                <label for="endDate" class="form-label">End Date & Time *</label>
                <input 
                  type="datetime-local" 
                  id="endDate" 
                  name="endDate"
                  class="form-input" 
                  required
                >
              </div>
            </div>

            <div class="form-group">
              <label for="eventLocation" class="form-label">Location *</label>
              <input 
                type="text" 
                id="eventLocation" 
                name="location"
                class="form-input" 
                required
                placeholder="Event location"
              >
            </div>

            <div class="form-group">
              <label class="form-label">Current Event Image</label>
              <div style="margin-top: var(--space-sm);">
                <img 
                  id="currentEventImage"
                  alt="Current event image"
                  style="width: 200px; height: 200px; object-fit: cover; border-radius: var(--radius-md); border: 2px solid var(--border);"
                  onerror="this.src='https://images.unsplash.com/photo-1540575467063-178a50c2df87?w=400&h=400&fit=crop'"
                >
              </div>
            </div>

            <div class="form-group">
              <label for="eventImage" class="form-label">Update Event Photo</label>
              <input 
                type="file" 
                id="eventImage" 
                name="photo"
                class="form-input" 
                accept="image/*"
              >
              <div class="form-hint">Upload a new image to update your event photo (JPG, PNG, GIF) - Leave empty to keep current image</div>
            </div>
          </div>

          <!-- Event Description -->
          <div style="margin-bottom: var(--space-xl);">
            <h3 style="margin-bottom: var(--space-md);">Description</h3>
            
            <div class="form-group">
              <label for="eventDescription" class="form-label">Event Description *</label>
              <textarea 
                id="eventDescription" 
                name="description"
                class="form-textarea" 
                required
                rows="6"
                placeholder="Describe your event..."
              ></textarea>
            </div>
          </div>

          <!-- Categories & Pricing -->
          <div style="margin-bottom: var(--space-xl);">
            <h3 style="margin-bottom: var(--space-md);">Ticket Categories & Pricing</h3>
            
            <div class="form-group">
              <label class="form-label">Ticket Categories *</label>
              <div class="form-hint">Manage ticket categories with seating capacity and pricing</div>
            </div>

            <div id="categoriesContainer">
              <!-- Categories will be dynamically populated here -->
            </div>

            <div class="form-group">
              <button type="button" class="btn btn-outline" onclick="addCategory()" id="addCategoryBtn">
                + Add Category
              </button>
            </div>
          </div>

          <!-- Form Actions -->
          <div style="border-top: 2px solid var(--border); padding-top: var(--space-lg);">
            <div class="flex gap-md" style="justify-content: flex-end; flex-wrap: wrap;">
              <a href="dashboard.html" class="btn btn-outline">
                Cancel
              </a>
              <button type="submit" class="btn btn-primary">
                üíæ Save Changes
              </button>
            </div>
          </div>
        </form>
      </div>

    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-section">
          <h4>Eventify</h4>
          <p class="text-muted">Discover and book amazing events in your area.</p>
        </div>
        <div class="footer-section">
          <h4>Quick Links</h4>
          <ul class="footer-links">
            <li><a href="index.html">Home</a></li>
            <li><a href="explore.html">Explore Events</a></li>
            <li><a href="about.html">About Us</a></li>
            <li><a href="dashboard.html">Dashboard</a></li>
          </ul>
        </div>
      </div>
      
      <div class="footer-bottom">
        <p>&copy; 2025 Eventify. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <!-- Scripts -->
  <script src="js/app.js"></script>
  <script>
    let currentEvent = null;

    // Get event ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const eventId = urlParams.get('id');

    // Load event details on page load
    document.addEventListener('DOMContentLoaded', async () => {
      // Check authentication
      const user = app.getCurrentUser();
      if (!user) {
        app.showNotification('Please log in to edit events', 'warning');
        setTimeout(() => {
          window.location.href = 'login.html?redirect=dashboard.html';
        }, 1000);
        return;
      }

      if (!eventId) {
        app.showNotification('Invalid event ID', 'error');
        setTimeout(() => {
          window.location.href = 'dashboard.html';
        }, 1000);
        return;
      }

      await loadEventDetails(eventId);

      // Setup form submission
      document.getElementById('editEventForm').addEventListener('submit', handleFormSubmit);
    });

    async function loadEventDetails(eventId) {
      try {
        const token = localStorage.getItem('eventify_token');
        const baseUrl = window.API_BASE_URL || 'https://eventify.runasp.net';
        
        const response = await fetch(`${baseUrl}/api/Events/${eventId}`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const result = await response.json();
          currentEvent = result.data || result;
          populateForm(currentEvent);
        } else {
          app.showNotification('Failed to load event details', 'error');
          setTimeout(() => {
            window.location.href = 'dashboard.html';
          }, 1000);
        }
      } catch (error) {
        console.error('Error loading event details:', error);
        app.showNotification('Error loading event details', 'error');
      }
    }

    function populateForm(event) {
      console.log('Populating form with event:', event);
      console.log('Event date fields:', {
        startDate: event.startDate,
        endDate: event.endDate,
        eventDate: event.eventDate,
        date: event.date,
        time: event.time
      });
      
      // Check if tickets have date information
      if (event.tickets && event.tickets.length > 0) {
        console.log('First ticket:', event.tickets[0]);
      }
      
      // Event title
      document.getElementById('eventTitle').value = event.name || event.title || '';
      
      // Start Date and Time - Try to get from tickets if main dates are invalid
      let startDateSource = event.startDate || event.eventDate || event.date;
      
      // If no valid date in main fields, try to get from first ticket
      if ((!startDateSource || startDateSource.startsWith('0001-01-01')) && event.tickets && event.tickets.length > 0) {
        const firstTicket = event.tickets[0];
        startDateSource = firstTicket.eventDate || firstTicket.startDate || firstTicket.date;
        console.log('Trying to get date from ticket:', startDateSource);
      }
      
      if (startDateSource && !startDateSource.startsWith('0001-01-01')) {
        const startDate = new Date(startDateSource);
        // Format as YYYY-MM-DDTHH:MM for datetime-local input
        const year = startDate.getFullYear();
        const month = String(startDate.getMonth() + 1).padStart(2, '0');
        const day = String(startDate.getDate()).padStart(2, '0');
        const hours = String(startDate.getHours()).padStart(2, '0');
        const minutes = String(startDate.getMinutes()).padStart(2, '0');
        const dateTimeStr = `${year}-${month}-${day}T${hours}:${minutes}`;
        
        // Show readable format with AM/PM in console
        const readableTime = startDate.toLocaleString('en-US', { 
          year: 'numeric', 
          month: 'short', 
          day: 'numeric',
          hour: 'numeric', 
          minute: '2-digit',
          hour12: true 
        });
        console.log('Setting startDate to:', dateTimeStr, '(', readableTime, ')');
        document.getElementById('startDate').value = dateTimeStr;
      } else {
        console.warn('No valid start date found - using default');
        // Set a default date (today) so the field isn't empty
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        const dateTimeStr = `${year}-${month}-${day}T12:00`;
        document.getElementById('startDate').value = dateTimeStr;
      }
      
      // End Date and Time
      let endDateSource = event.endDate || event.endDateTime;
      
      if ((!endDateSource || endDateSource.startsWith('0001-01-01')) && event.tickets && event.tickets.length > 0) {
        const firstTicket = event.tickets[0];
        endDateSource = firstTicket.endDate || firstTicket.eventEndDate;
      }
      
      if (endDateSource && !endDateSource.startsWith('0001-01-01')) {
        const endDate = new Date(endDateSource);
        // Format as YYYY-MM-DDTHH:MM for datetime-local input
        const year = endDate.getFullYear();
        const month = String(endDate.getMonth() + 1).padStart(2, '0');
        const day = String(endDate.getDate()).padStart(2, '0');
        const hours = String(endDate.getHours()).padStart(2, '0');
        const minutes = String(endDate.getMinutes()).padStart(2, '0');
        const dateTimeStr = `${year}-${month}-${day}T${hours}:${minutes}`;
        
        // Show readable format with AM/PM in console
        const readableTime = endDate.toLocaleString('en-US', { 
          year: 'numeric', 
          month: 'short', 
          day: 'numeric',
          hour: 'numeric', 
          minute: '2-digit',
          hour12: true 
        });
        console.log('Setting endDate to:', dateTimeStr, '(', readableTime, ')');
        document.getElementById('endDate').value = dateTimeStr;
      } else {
        console.warn('No valid end date found - using default');
        // Set default end date (1 hour after start)
        const startInput = document.getElementById('startDate').value;
        if (startInput) {
          const startDateTime = new Date(startInput);
          startDateTime.setHours(startDateTime.getHours() + 2);
          const year = startDateTime.getFullYear();
          const month = String(startDateTime.getMonth() + 1).padStart(2, '0');
          const day = String(startDateTime.getDate()).padStart(2, '0');
          const hours = String(startDateTime.getHours()).padStart(2, '0');
          const minutes = String(startDateTime.getMinutes()).padStart(2, '0');
          const dateTimeStr = `${year}-${month}-${day}T${hours}:${minutes}`;
          document.getElementById('endDate').value = dateTimeStr;
        }
      }
      
      // Location/Address
      document.getElementById('eventLocation').value = event.address || event.location || '';
      
      // Display current image
      const imageUrl = event.photoUrl || event.image || '';
      if (imageUrl) {
        document.getElementById('currentEventImage').src = imageUrl;
      }
      
      // Description
      document.getElementById('eventDescription').value = event.description || '';
      
      // Populate categories
      console.log('Event categories:', event.categories);
      if (event.categories && event.categories.length > 0) {
        event.categories.forEach((cat, index) => {
          console.log(`Category ${index}:`, cat);
          addCategory(cat);
        });
      } else {
        // Add one empty category if none exist
        console.log('No categories found, adding empty category');
        addCategory();
      }
    }

    function addCategory(categoryData = null) {
      const container = document.getElementById('categoriesContainer');
      if (!container) return;

      console.log('Adding category with data:', categoryData);

      // Extract values with all possible field name variations
      const categoryId = categoryData?.id || '';
      const categoryName = categoryData?.name || categoryData?.title || '';
      const categoryCapacity = categoryData?.capacity || categoryData?.seats || categoryData?.numberOfSeats || '';
      const categoryPrice = categoryData?.price || categoryData?.ticketPrice || categoryData?.pricePerTicket || 0;

      const categoryCardId = `category-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
      const categoryHtml = `
        <div class="category-item" id="${categoryCardId}" style="
          border: 2px solid var(--border); 
          border-radius: var(--radius-md); 
          padding: var(--space-lg); 
          margin-bottom: var(--space-md);
          position: relative;
        ">
          <input type="hidden" class="category-id" value="${categoryId}">
          <div class="form-row">
            <div class="form-group" style="flex: 2;">
              <label class="form-label">Category Title *</label>
              <input 
                type="text" 
                class="form-input category-title" 
                placeholder="e.g., VIP, Premium, Regular"
                value="${categoryName}"
                required
              >
            </div>
            <div class="form-group" style="flex: 1;">
              <label class="form-label">Seats *</label>
              <input 
                type="number" 
                class="form-input category-seats" 
                placeholder="50"
                min="1"
                max="10000"
                value="${categoryCapacity}"
                required
              >
            </div>
            <div class="form-group" style="flex: 1;">
              <label class="form-label">Ticket Price *</label>
              <input 
                type="number" 
                class="form-input category-price" 
                placeholder="0.00"
                min="0"
                step="0.01"
                value="${categoryPrice}"
                required
              >
            </div>
            <div class="form-group" style="flex: 0 0 auto;">
              <label class="form-label" style="visibility: hidden;">Remove</label>
              <button 
                type="button" 
                class="btn btn-outline" 
                style="background: var(--danger); color: white; border-color: var(--danger);"
                onclick="removeCategory('${categoryId}')"
              >
                ‚úï
              </button>
            </div>
          </div>
        </div>
      `;

      container.insertAdjacentHTML('beforeend', categoryHtml);
      updateAddButtonState();
    }

    function removeCategory(categoryId) {
      const categoryElement = document.getElementById(categoryId);
      if (categoryElement) {
        categoryElement.remove();
        updateAddButtonState();
      }
    }

    function updateAddButtonState() {
      const container = document.getElementById('categoriesContainer');
      const addBtn = document.getElementById('addCategoryBtn');
      if (container && addBtn) {
        const categoryCount = container.querySelectorAll('.category-item').length;
        addBtn.disabled = categoryCount >= 10;
        if (categoryCount >= 10) {
          addBtn.textContent = 'Maximum 10 categories reached';
        } else {
          addBtn.textContent = '+ Add Category';
        }
      }
    }

    function getCategories() {
      const categories = [];
      const categoryItems = document.querySelectorAll('.category-item');
      
      categoryItems.forEach(item => {
        const id = item.querySelector('.category-id')?.value || null;
        const title = item.querySelector('.category-title')?.value;
        const seats = item.querySelector('.category-seats')?.value;
        const price = item.querySelector('.category-price')?.value;
        
        if (title && seats && price !== undefined) {
          categories.push({
            id: id || undefined,
            name: title,
            capacity: parseInt(seats),
            ticketPrice: parseFloat(price)
          });
        }
      });
      
      return categories;
    }

    async function handleFormSubmit(e) {
      e.preventDefault();

      // Validate form
      if (!e.target.checkValidity()) {
        app.showNotification('Please fill in all required fields', 'error');
        e.target.reportValidity();
        return;
      }

      // Get categories
      const categories = getCategories();
      if (categories.length === 0) {
        app.showNotification('Please add at least one ticket category', 'error');
        return;
      }

      // Get datetime-local values and convert to ISO format
      const startDateValue = document.getElementById('startDate').value;
      const endDateValue = document.getElementById('endDate').value;
      
      const startDate = new Date(startDateValue).toISOString();
      const endDate = new Date(endDateValue).toISOString();

      // Get form data
      const formData = {
        name: document.getElementById('eventTitle').value,
        startDate: startDate,
        endDate: endDate,
        address: document.getElementById('eventLocation').value,
        photoUrl: document.getElementById('eventImage').value,
        description: document.getElementById('eventDescription').value,
        categories: categories
      };

      console.log('Updating event with data:', formData);

      try {
        const token = localStorage.getItem('eventify_token');
        const baseUrl = window.API_BASE_URL || 'https://eventify.runasp.net';
        
        const response = await fetch(`${baseUrl}/api/Events/${currentEvent.id}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });

        if (response.ok) {
          app.showNotification('Event updated successfully!', 'success');
          setTimeout(() => {
            window.location.href = 'dashboard.html';
          }, 1500);
        } else {
          const errorData = await response.json().catch(() => ({}));
          app.showNotification(errorData.message || 'Failed to update event', 'error');
        }
      } catch (error) {
        console.error('Error updating event:', error);
        app.showNotification('Error updating event', 'error');
      }
    }
  </script>
</body>
</html>
