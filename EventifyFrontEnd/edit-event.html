<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Event - Eventify</title>
  <link rel="stylesheet" href="css/styles.css">
  
  <!-- Favicon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚úèÔ∏è</text></svg>">
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar">
    <div class="container">
      <div class="navbar-brand">
        <a href="index.html">
          <span style="font-size: var(--font-size-xl); font-weight: 700;">üéâ Eventify</span>
        </a>
      </div>
      <ul class="navbar-nav">
        <li><a href="index.html">Home</a></li>
        <li><a href="explore.html">Explore</a></li>
        <li><a href="dashboard.html">Dashboard</a></li>
      </ul>
      <div class="navbar-actions">
        <a href="#" onclick="app.logout(); return false;" class="btn btn-outline">Logout</a>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="main-content">
    <div class="container" style="max-width: 900px; padding-top: var(--space-xl); padding-bottom: var(--space-xl);">
      
      <!-- Back Button -->
      <div style="margin-bottom: var(--space-lg);">
        <a href="dashboard.html" class="btn btn-outline">
          ‚Üê Back to Dashboard
        </a>
      </div>

      <!-- Edit Event Form -->
      <div class="card">
        <div style="border-bottom: 2px solid var(--border); padding-bottom: var(--space-lg); margin-bottom: var(--space-lg);">
          <h1 style="margin-bottom: var(--space-xs);">Edit Event</h1>
          <p class="text-muted">Update your event details</p>
        </div>

        <form id="editEventForm" novalidate>
          <!-- Event Details -->
          <div style="margin-bottom: var(--space-xl);">
            <h3 style="margin-bottom: var(--space-md);">Event Details</h3>
            
            <div class="form-group">
              <label for="eventTitle" class="form-label">Event Name *</label>
              <input 
                type="text" 
                id="eventTitle" 
                name="title"
                class="form-input" 
                required
                minlength="3"
                maxlength="100"
                placeholder="Event name"
              >
              <div class="form-hint">Make it clear and engaging (3-100 characters)</div>
              <div class="error-message" id="titleError"></div>
            </div>

            <div class="form-group">
              <label for="eventCategory" class="form-label">Event Category *</label>
              <select 
                id="eventCategory" 
                name="eventCategory"
                class="form-input" 
                required
              >
                <option value="">Select a category...</option>
                <option value="1">Music</option>
                <option value="2">Sports</option>
                <option value="3">Arts</option>
                <option value="4">Food</option>
                <option value="5">Technology</option>
                <option value="6">Business</option>
                <option value="7">Education</option>
                <option value="8">Entertainment</option>
                <option value="9">Health</option>
                <option value="10">Community</option>
                <option value="11">Other</option>
              </select>
              <div class="form-hint">Choose the category that best describes your event</div>
              <div class="error-message" id="categoryError"></div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="startDate" class="form-label">Start Date & Time *</label>
                <input 
                  type="datetime-local" 
                  id="startDate" 
                  name="startDate"
                  class="form-input" 
                  required
                >
                <div class="error-message" id="startDateError"></div>
              </div>

              <div class="form-group">
                <label for="endDate" class="form-label">End Date & Time *</label>
                <input 
                  type="datetime-local" 
                  id="endDate" 
                  name="endDate"
                  class="form-input" 
                  required
                >
                <div class="error-message" id="endDateError"></div>
              </div>
            </div>

            <div class="form-group">
              <label for="eventLocation" class="form-label">Event Address *</label>
              <input 
                type="text" 
                id="eventLocation" 
                name="location"
                class="form-input" 
                required
                minlength="5"
                maxlength="200"
                placeholder="Enter venue address"
              >
              <div class="form-hint">Full address or venue location (5-200 characters)</div>
              <div class="error-message" id="locationError"></div>
            </div>

            <div class="form-group">
              <label class="form-label">Current Event Image</label>
              <div style="margin-top: var(--space-sm);">
                <img 
                  id="currentEventImage"
                  alt="Current event image"
                  style="width: 200px; height: 200px; object-fit: cover; border-radius: var(--radius-md); border: 2px solid var(--border);"
                  onerror="this.src='https://images.unsplash.com/photo-1540575467063-178a50c2df87?w=400&h=400&fit=crop'"
                >
              </div>
            </div>

            <div class="form-group">
              <label for="eventImage" class="form-label">Update Event Photo</label>
              <input 
                type="file" 
                id="eventImage" 
                name="photo"
                class="form-input" 
                accept="image/jpeg,image/png,image/gif"
              >
              <div class="form-hint">Upload a new image to update your event photo (JPG, PNG, GIF, max 5MB) - Leave empty to keep current image</div>
              <div class="error-message" id="imageError"></div>
              <div id="imagePreview" style="margin-top: var(--space-sm); display: none;">
                <img id="previewImage" style="max-width: 200px; height: auto; border-radius: var(--radius-md); border: 2px solid var(--border);">
              </div>
            </div>
          </div>

          <!-- Event Description -->
          <div style="margin-bottom: var(--space-xl);">
            <h3 style="margin-bottom: var(--space-md);">Description</h3>
            
            <div class="form-group">
              <label for="eventDescription" class="form-label">Event Description *</label>
              <textarea 
                id="eventDescription" 
                name="description"
                class="form-textarea" 
                required
                minlength="10"
                maxlength="1000"
                rows="6"
                placeholder="Describe your event..."
              ></textarea>
              <div class="form-hint">
                <span id="descCharCount">0</span>/1000 characters (10 minimum required)
              </div>
              <div class="error-message" id="descriptionError"></div>
            </div>
          </div>

          <!-- Categories & Pricing -->
          <div style="margin-bottom: var(--space-xl);">
            <h3 style="margin-bottom: var(--space-md);">Ticket Categories & Pricing</h3>
            
            <div class="form-group">
              <label class="form-label">Ticket Categories *</label>
              <div class="form-hint">Manage ticket categories with seating capacity and pricing</div>
            </div>

            <div id="categoriesContainer">
              <!-- Categories will be dynamically populated here -->
            </div>

            <div class="form-group">
              <button type="button" class="btn btn-outline" onclick="addCategory()" id="addCategoryBtn">
                + Add Category
              </button>
            </div>
          </div>

          <!-- Form Actions -->
          <div style="border-top: 2px solid var(--border); padding-top: var(--space-lg);">
            <div class="flex gap-md" style="justify-content: flex-end; flex-wrap: wrap;">
              <a href="dashboard.html" class="btn btn-outline">
                Cancel
              </a>
              <button type="submit" class="btn btn-primary">
                üíæ Save Changes
              </button>
            </div>
          </div>
        </form>
      </div>

    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-section">
          <h4>Eventify</h4>
          <p class="text-muted">Discover and book amazing events in your area.</p>
        </div>
        <div class="footer-section">
          <h4>Quick Links</h4>
          <ul class="footer-links">
            <li><a href="index.html">Home</a></li>
            <li><a href="explore.html">Explore Events</a></li>
            <li><a href="about.html">About Us</a></li>
            <li><a href="dashboard.html">Dashboard</a></li>
          </ul>
        </div>
      </div>
      
      <div class="footer-bottom">
        <p>&copy; 2025 Eventify. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <!-- Scripts -->
  <script src="js/app.js"></script>
  <script>
    let currentEvent = null;

    // Get event ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const eventId = urlParams.get('id');

    // Load event details on page load
    document.addEventListener('DOMContentLoaded', async () => {
      // Check authentication
      const user = app.getCurrentUser();
      if (!user) {
        app.showNotification('Please log in to edit events', 'warning');
        setTimeout(() => {
          window.location.href = 'login.html?redirect=dashboard.html';
        }, 1000);
        return;
      }

      if (!eventId) {
        app.showNotification('Invalid event ID', 'error');
        setTimeout(() => {
          window.location.href = 'dashboard.html';
        }, 1000);
        return;
      }

      await loadEventDetails(eventId);

      // Setup form submission
      document.getElementById('editEventForm').addEventListener('submit', handleFormSubmit);
      
      // Setup validation listeners
      setupValidationListeners();
      
      // Setup image preview
      document.getElementById('eventImage').addEventListener('change', handleImagePreview);
    });

    async function loadEventDetails(eventId) {
      try {
        const token = localStorage.getItem('eventify_token');
        const baseUrl = window.API_BASE_URL || 'https://eventify.runasp.net';
        
        const response = await fetch(`${baseUrl}/api/Events/${eventId}`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const result = await response.json();
          currentEvent = result.data || result;
          populateForm(currentEvent);
        } else {
          app.showNotification('Failed to load event details', 'error');
          setTimeout(() => {
            window.location.href = 'dashboard.html';
          }, 1000);
        }
      } catch (error) {
        console.error('Error loading event details:', error);
        app.showNotification('Error loading event details', 'error');
      }
    }

    function populateForm(event) {
      console.log('Populating form with event:', event);
      console.log('Event date fields:', {
        startDate: event.startDate,
        endDate: event.endDate,
        eventDate: event.eventDate,
        date: event.date,
        time: event.time
      });
      
      // Check if tickets have date information
      if (event.tickets && event.tickets.length > 0) {
        console.log('First ticket:', event.tickets[0]);
      }
      
      // Event title
      document.getElementById('eventTitle').value = event.name || event.title || '';
      
      // Event category
      if (event.eventCategory !== undefined && event.eventCategory !== null) {
        document.getElementById('eventCategory').value = event.eventCategory.toString();
      }
      
      // Start Date and Time - Try to get from tickets if main dates are invalid
      let startDateSource = event.startDate || event.eventDate || event.date;
      
      // If no valid date in main fields, try to get from first ticket
      if ((!startDateSource || startDateSource.startsWith('0001-01-01')) && event.tickets && event.tickets.length > 0) {
        const firstTicket = event.tickets[0];
        startDateSource = firstTicket.eventDate || firstTicket.startDate || firstTicket.date;
        console.log('Trying to get date from ticket:', startDateSource);
      }
      
      if (startDateSource && !startDateSource.startsWith('0001-01-01')) {
        const startDate = new Date(startDateSource);
        // Format as YYYY-MM-DDTHH:MM for datetime-local input
        const year = startDate.getFullYear();
        const month = String(startDate.getMonth() + 1).padStart(2, '0');
        const day = String(startDate.getDate()).padStart(2, '0');
        const hours = String(startDate.getHours()).padStart(2, '0');
        const minutes = String(startDate.getMinutes()).padStart(2, '0');
        const dateTimeStr = `${year}-${month}-${day}T${hours}:${minutes}`;
        
        // Show readable format with AM/PM in console
        const readableTime = startDate.toLocaleString('en-US', { 
          year: 'numeric', 
          month: 'short', 
          day: 'numeric',
          hour: 'numeric', 
          minute: '2-digit',
          hour12: true 
        });
        console.log('Setting startDate to:', dateTimeStr, '(', readableTime, ')');
        document.getElementById('startDate').value = dateTimeStr;
      } else {
        console.warn('No valid start date found - using default');
        // Set a default date (today) so the field isn't empty
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        const dateTimeStr = `${year}-${month}-${day}T12:00`;
        document.getElementById('startDate').value = dateTimeStr;
      }
      
      // End Date and Time
      let endDateSource = event.endDate || event.endDateTime;
      
      if ((!endDateSource || endDateSource.startsWith('0001-01-01')) && event.tickets && event.tickets.length > 0) {
        const firstTicket = event.tickets[0];
        endDateSource = firstTicket.endDate || firstTicket.eventEndDate;
      }
      
      if (endDateSource && !endDateSource.startsWith('0001-01-01')) {
        const endDate = new Date(endDateSource);
        // Format as YYYY-MM-DDTHH:MM for datetime-local input
        const year = endDate.getFullYear();
        const month = String(endDate.getMonth() + 1).padStart(2, '0');
        const day = String(endDate.getDate()).padStart(2, '0');
        const hours = String(endDate.getHours()).padStart(2, '0');
        const minutes = String(endDate.getMinutes()).padStart(2, '0');
        const dateTimeStr = `${year}-${month}-${day}T${hours}:${minutes}`;
        
        // Show readable format with AM/PM in console
        const readableTime = endDate.toLocaleString('en-US', { 
          year: 'numeric', 
          month: 'short', 
          day: 'numeric',
          hour: 'numeric', 
          minute: '2-digit',
          hour12: true 
        });
        console.log('Setting endDate to:', dateTimeStr, '(', readableTime, ')');
        document.getElementById('endDate').value = dateTimeStr;
      } else {
        console.warn('No valid end date found - using default');
        // Set default end date (1 hour after start)
        const startInput = document.getElementById('startDate').value;
        if (startInput) {
          const startDateTime = new Date(startInput);
          startDateTime.setHours(startDateTime.getHours() + 2);
          const year = startDateTime.getFullYear();
          const month = String(startDateTime.getMonth() + 1).padStart(2, '0');
          const day = String(startDateTime.getDate()).padStart(2, '0');
          const hours = String(startDateTime.getHours()).padStart(2, '0');
          const minutes = String(startDateTime.getMinutes()).padStart(2, '0');
          const dateTimeStr = `${year}-${month}-${day}T${hours}:${minutes}`;
          document.getElementById('endDate').value = dateTimeStr;
        }
      }
      
      // Location/Address
      document.getElementById('eventLocation').value = event.address || event.location || '';
      
      // Display current image
      const imageUrl = event.photoUrl || event.image || '';
      if (imageUrl) {
        document.getElementById('currentEventImage').src = imageUrl;
      }
      
      // Description
      document.getElementById('eventDescription').value = event.description || '';
      
      // Populate categories
      console.log('Event categories:', event.categories);
      if (event.categories && event.categories.length > 0) {
        event.categories.forEach((cat, index) => {
          console.log(`Category ${index}:`, cat);
          addCategory(cat);
        });
      } else {
        // Add one empty category if none exist
        console.log('No categories found, adding empty category');
        addCategory();
      }
    }

    function addCategory(categoryData = null) {
      const container = document.getElementById('categoriesContainer');
      if (!container) return;

      console.log('Adding category with data:', categoryData);

      // Extract values with all possible field name variations
      const categoryId = categoryData?.id || '';
      const categoryName = categoryData?.name || categoryData?.title || '';
      const categoryCapacity = categoryData?.capacity || categoryData?.seats || categoryData?.numberOfSeats || '';
      const categoryPrice = categoryData?.price || categoryData?.ticketPrice || categoryData?.pricePerTicket || 0;

      const categoryCardId = `category-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
      const categoryHtml = `
        <div class="category-item" id="${categoryCardId}" style="
          border: 2px solid var(--border); 
          border-radius: var(--radius-md); 
          padding: var(--space-lg); 
          margin-bottom: var(--space-md);
          position: relative;
        ">
          <input type="hidden" class="category-id" value="${categoryId}">
          <div class="form-row">
            <div class="form-group" style="flex: 2;">
              <label class="form-label">Category Title *</label>
              <input 
                type="text" 
                class="form-input category-title" 
                placeholder="e.g., VIP, Premium, Regular"
                value="${categoryName}"
                minlength="2"
                maxlength="50"
                required
              >
              <div class="error-message category-title-error"></div>
            </div>
            <div class="form-group" style="flex: 1;">
              <label class="form-label">Seats *</label>
              <input 
                type="number" 
                class="form-input category-seats" 
                placeholder="50"
                min="1"
                max="10000"
                value="${categoryCapacity}"
                required
              >
              <div class="error-message category-seats-error"></div>
            </div>
            <div class="form-group" style="flex: 1;">
              <label class="form-label">Ticket Price *</label>
              <input 
                type="number" 
                class="form-input category-price" 
                placeholder="0.00"
                min="0"
                step="0.01"
                value="${categoryPrice}"
                required
              >
              <div class="error-message category-price-error"></div>
            </div>
            <div class="form-group" style="flex: 0 0 auto;">
              <label class="form-label" style="visibility: hidden;">Remove</label>
              <button 
                type="button" 
                class="btn btn-outline" 
                style="background: var(--danger); color: white; border-color: var(--danger);"
                onclick="removeCategory('${categoryCardId}')"
              >
                ‚úï
              </button>
            </div>
          </div>
        </div>
      `;

      container.insertAdjacentHTML('beforeend', categoryHtml);
      updateAddButtonState();
      attachCategoryValidation(categoryCardId);
    }

    function removeCategory(categoryCardId) {
      const container = document.getElementById('categoriesContainer');
      const categoryCount = container.querySelectorAll('.category-item').length;
      
      if (categoryCount <= 1) {
        app.showNotification('You must have at least one ticket category', 'error');
        return;
      }
      
      const categoryElement = document.getElementById(categoryCardId);
      if (categoryElement) {
        categoryElement.remove();
        updateAddButtonState();
      }
    }

    function updateAddButtonState() {
      const container = document.getElementById('categoriesContainer');
      const addBtn = document.getElementById('addCategoryBtn');
      if (container && addBtn) {
        const categoryCount = container.querySelectorAll('.category-item').length;
        addBtn.disabled = categoryCount >= 10;
        if (categoryCount >= 10) {
          addBtn.textContent = 'Maximum 10 categories reached';
        } else {
          addBtn.textContent = '+ Add Category';
        }
      }
    }

    function setupValidationListeners() {
      // Title validation
      const titleInput = document.getElementById('eventTitle');
      titleInput.addEventListener('input', function() {
        validateField(this, 'titleError', 
          this.value.length >= 3 && this.value.length <= 100,
          'Event name must be between 3 and 100 characters');
      });

      // Description validation with character counter
      const descInput = document.getElementById('eventDescription');
      descInput.addEventListener('input', function() {
        const charCount = this.value.length;
        document.getElementById('descCharCount').textContent = charCount;
        validateField(this, 'descriptionError', 
          charCount >= 10 && charCount <= 1000,
          'Description must be between 10 and 1000 characters');
      });

      // Location validation
      const locationInput = document.getElementById('eventLocation');
      locationInput.addEventListener('input', function() {
        validateField(this, 'locationError', 
          this.value.length >= 5 && this.value.length <= 200,
          'Address must be between 5 and 200 characters');
      });

      // Date validation
      const startDateInput = document.getElementById('startDate');
      const endDateInput = document.getElementById('endDate');
      
      startDateInput.addEventListener('change', function() {
        validateDates();
      });
      
      endDateInput.addEventListener('change', function() {
        validateDates();
      });

      // Category validation
      const categorySelect = document.getElementById('eventCategory');
      categorySelect.addEventListener('change', function() {
        validateField(this, 'categoryError', 
          this.value !== '',
          'Please select an event category');
      });
    }

    function validateField(input, errorId, isValid, errorMessage) {
      const errorElement = document.getElementById(errorId);
      if (!isValid) {
        input.style.borderColor = 'var(--danger)';
        if (errorElement) {
          errorElement.textContent = errorMessage;
          errorElement.style.color = 'var(--danger)';
          errorElement.style.fontSize = 'var(--font-size-sm)';
          errorElement.style.marginTop = 'var(--space-xs)';
        }
        return false;
      } else {
        input.style.borderColor = '';
        if (errorElement) {
          errorElement.textContent = '';
        }
        return true;
      }
    }

    function validateDates() {
      const startDate = new Date(document.getElementById('startDate').value);
      const endDate = new Date(document.getElementById('endDate').value);
      const now = new Date();
      
      let isValid = true;
      
      // Validate start date is not in the past (allow some flexibility)
      if (startDate < now) {
        validateField(document.getElementById('startDate'), 'startDateError', 
          false, 'Start date cannot be in the past');
        isValid = false;
      } else {
        validateField(document.getElementById('startDate'), 'startDateError', true, '');
      }
      
      // Validate end date is after start date
      if (endDate <= startDate) {
        validateField(document.getElementById('endDate'), 'endDateError', 
          false, 'End date must be after start date');
        isValid = false;
      } else {
        validateField(document.getElementById('endDate'), 'endDateError', true, '');
      }
      
      return isValid;
    }

    function handleImagePreview(e) {
      const file = e.target.files[0];
      const errorElement = document.getElementById('imageError');
      
      if (!file) {
        document.getElementById('imagePreview').style.display = 'none';
        return;
      }
      
      // Validate file type
      const validTypes = ['image/jpeg', 'image/png', 'image/gif'];
      if (!validTypes.includes(file.type)) {
        errorElement.textContent = 'Please upload a valid image file (JPG, PNG, or GIF)';
        errorElement.style.color = 'var(--danger)';
        e.target.value = '';
        return;
      }
      
      // Validate file size (5MB)
      const maxSize = 5 * 1024 * 1024;
      if (file.size > maxSize) {
        errorElement.textContent = 'Image size must be less than 5MB';
        errorElement.style.color = 'var(--danger)';
        e.target.value = '';
        return;
      }
      
      errorElement.textContent = '';
      
      // Show preview
      const reader = new FileReader();
      reader.onload = function(event) {
        document.getElementById('previewImage').src = event.target.result;
        document.getElementById('imagePreview').style.display = 'block';
      };
      reader.readAsDataURL(file);
    }

    function attachCategoryValidation(categoryCardId) {
      const categoryCard = document.getElementById(categoryCardId);
      if (!categoryCard) return;
      
      const titleInput = categoryCard.querySelector('.category-title');
      const seatsInput = categoryCard.querySelector('.category-seats');
      const priceInput = categoryCard.querySelector('.category-price');
      
      titleInput.addEventListener('input', function() {
        const errorElement = this.parentElement.querySelector('.category-title-error');
        const isValid = this.value.length >= 2 && this.value.length <= 50;
        if (!isValid) {
          this.style.borderColor = 'var(--danger)';
          errorElement.textContent = 'Title must be 2-50 characters';
          errorElement.style.color = 'var(--danger)';
          errorElement.style.fontSize = 'var(--font-size-sm)';
        } else {
          this.style.borderColor = '';
          errorElement.textContent = '';
        }
      });
      
      seatsInput.addEventListener('input', function() {
        const errorElement = this.parentElement.querySelector('.category-seats-error');
        const value = parseInt(this.value);
        const isValid = value >= 1 && value <= 10000;
        if (!isValid) {
          this.style.borderColor = 'var(--danger)';
          errorElement.textContent = 'Seats must be between 1 and 10,000';
          errorElement.style.color = 'var(--danger)';
          errorElement.style.fontSize = 'var(--font-size-sm)';
        } else {
          this.style.borderColor = '';
          errorElement.textContent = '';
        }
      });
      
      priceInput.addEventListener('input', function() {
        const errorElement = this.parentElement.querySelector('.category-price-error');
        const value = parseFloat(this.value);
        const isValid = value >= 0 && this.value.match(/^\d+(\.\d{0,2})?$/);
        if (!isValid) {
          this.style.borderColor = 'var(--danger)';
          errorElement.textContent = 'Price must be 0 or more with max 2 decimals';
          errorElement.style.color = 'var(--danger)';
          errorElement.style.fontSize = 'var(--font-size-sm)';
        } else {
          this.style.borderColor = '';
          errorElement.textContent = '';
        }
      });
    }

    function validateCategories() {
      const categories = getCategories();
      
      if (categories.length === 0) {
        app.showNotification('Please add at least one ticket category', 'error');
        return false;
      }
      
      // Check for duplicate names
      const names = categories.map(c => c.name.toLowerCase().trim());
      const duplicates = names.filter((name, index) => names.indexOf(name) !== index);
      if (duplicates.length > 0) {
        app.showNotification('Category names must be unique', 'error');
        return false;
      }
      
      // Validate each category
      for (let cat of categories) {
        if (!cat.name || cat.name.length < 2 || cat.name.length > 50) {
          app.showNotification('All category titles must be 2-50 characters', 'error');
          return false;
        }
        if (cat.capacity < 1 || cat.capacity > 10000) {
          app.showNotification('All category seats must be between 1 and 10,000', 'error');
          return false;
        }
        if (cat.ticketPrice < 0) {
          app.showNotification('All category prices must be 0 or greater', 'error');
          return false;
        }
      }
      
      return true;
    }

    function getCategories() {
      const categories = [];
      const categoryItems = document.querySelectorAll('.category-item');
      
      categoryItems.forEach(item => {
        const id = item.querySelector('.category-id')?.value || null;
        const title = item.querySelector('.category-title')?.value;
        const seats = item.querySelector('.category-seats')?.value;
        const price = item.querySelector('.category-price')?.value;
        
        if (title && seats && price !== undefined) {
          categories.push({
            id: id || undefined,
            name: title,
            capacity: parseInt(seats),
            ticketPrice: parseFloat(price)
          });
        }
      });
      
      return categories;
    }

    async function handleFormSubmit(e) {
      e.preventDefault();

      // Disable submit button to prevent double submission
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = '‚è≥ Updating...';

      try {
        // Validate all fields
        const titleValid = validateField(
          document.getElementById('eventTitle'), 
          'titleError',
          document.getElementById('eventTitle').value.length >= 3 && 
          document.getElementById('eventTitle').value.length <= 100,
          'Event name must be between 3 and 100 characters'
        );

        const categoryValid = validateField(
          document.getElementById('eventCategory'), 
          'categoryError',
          document.getElementById('eventCategory').value !== '',
          'Please select an event category'
        );

        const locationValid = validateField(
          document.getElementById('eventLocation'), 
          'locationError',
          document.getElementById('eventLocation').value.length >= 5 && 
          document.getElementById('eventLocation').value.length <= 200,
          'Address must be between 5 and 200 characters'
        );

        const descriptionValid = validateField(
          document.getElementById('eventDescription'), 
          'descriptionError',
          document.getElementById('eventDescription').value.length >= 10 && 
          document.getElementById('eventDescription').value.length <= 1000,
          'Description must be between 10 and 1000 characters'
        );

        const datesValid = validateDates();
        const categoriesValid = validateCategories();

        if (!titleValid || !categoryValid || !locationValid || !descriptionValid || !datesValid || !categoriesValid) {
          app.showNotification('Please fix all validation errors', 'error');
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
          return;
        }

        // Create FormData
        const formData = new FormData();

        // Add basic fields
        formData.append('Name', document.getElementById('eventTitle').value);
        formData.append('Description', document.getElementById('eventDescription').value);
        formData.append('Address', document.getElementById('eventLocation').value);
        
        // Add dates in ISO format
        const startDate = new Date(document.getElementById('startDate').value).toISOString();
        const endDate = new Date(document.getElementById('endDate').value).toISOString();
        formData.append('StartDate', startDate);
        formData.append('EndDate', endDate);

        // Add event category
        formData.append('EventCategory', document.getElementById('eventCategory').value);

        // Add photo if selected
        const photoFile = document.getElementById('eventImage').files[0];
        if (photoFile) {
          formData.append('Photo', photoFile);
        }

        // Add categories - backend expects CategoryIds array
        const categories = getCategories();
        const categoryIds = categories
          .filter(cat => cat.id)
          .map(cat => parseInt(cat.id));
        
        categoryIds.forEach(id => {
          formData.append('CategoryIds', id);
        });

        console.log('Updating event with FormData');
        // Log FormData contents
        for (let pair of formData.entries()) {
          console.log(pair[0] + ': ' + pair[1]);
        }

        const token = localStorage.getItem('eventify_token');
        const baseUrl = window.API_BASE_URL || 'https://eventify.runasp.net';
        
        const response = await fetch(`${baseUrl}/api/Events/${currentEvent.id}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`
            // Don't set Content-Type for FormData - browser will set it with boundary
          },
          body: formData
        });

        if (response.ok) {
          app.showNotification('Event updated successfully!', 'success');
          setTimeout(() => {
            window.location.href = 'dashboard.html';
          }, 1500);
        } else {
          const errorData = await response.json().catch(() => ({}));
          console.error('Update error:', errorData);
          app.showNotification(errorData.message || 'Failed to update event', 'error');
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      } catch (error) {
        console.error('Error updating event:', error);
        app.showNotification('Error updating event', 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    }

    // Warn before leaving with unsaved changes
    let formChanged = false;
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('editEventForm');
      if (form) {
        form.addEventListener('input', () => {
          formChanged = true;
        });
      }
    });

    window.addEventListener('beforeunload', (e) => {
      if (formChanged) {
        e.preventDefault();
        e.returnValue = '';
      }
    });
  </script>
</body>
</html>
